# =============================================================================
# GitHub Actions - Deploy Blacklight Portal Frontend to Cloud Run
# =============================================================================
# Triggers only when ui/portal/ files change
# =============================================================================

name: Deploy Portal

on:
  push:
    branches: [main]
    paths:
      - 'ui/portal/**'
      - '.github/workflows/deploy-portal.yml'
  workflow_dispatch:  # Allow manual trigger

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.GCP_REGION || 'us-central1' }}
  SERVICE_NAME: blacklight-portal
  BACKEND_SERVICE: blacklight-api

jobs:
  deploy:
    name: Build and Deploy Portal
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Get Backend URL
        id: backend
        run: |
          URL=$(gcloud run services describe ${{ env.BACKEND_SERVICE }} \
            --region ${{ env.REGION }} \
            --format 'value(status.url)' 2>/dev/null || echo "")
          if [ -z "$URL" ]; then
            echo "⚠️ Backend not deployed yet, using placeholder"
            URL="https://${{ env.BACKEND_SERVICE }}-${{ env.PROJECT_ID }}.${{ env.REGION }}.run.app"
          fi
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "Backend URL: $URL"

      - name: Build Docker image
        working-directory: ./ui/portal
        run: |
          docker build \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/blacklight/${{ env.SERVICE_NAME }}:${{ github.sha }} \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/blacklight/${{ env.SERVICE_NAME }}:latest \
            --build-arg VITE_API_URL=${{ steps.backend.outputs.url }} \
            -f Dockerfile .

      - name: Push Docker image
        run: |
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/blacklight/${{ env.SERVICE_NAME }}:${{ github.sha }}
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/blacklight/${{ env.SERVICE_NAME }}:latest

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/blacklight/${{ env.SERVICE_NAME }}:${{ github.sha }} \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 256Mi \
            --cpu 1 \
            --min-instances 0 \
            --max-instances 10 \
            --timeout 60 \
            --concurrency 200

      - name: Get Service URL and Update Backend CORS
        run: |
          PORTAL_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')
          echo "✅ Portal deployed to: $PORTAL_URL"
          
          # Get CentralD URL if exists
          CENTRALD_URL=$(gcloud run services describe blacklight-centrald \
            --region ${{ env.REGION }} \
            --format 'value(status.url)' 2>/dev/null || echo "")
          
          # Update backend CORS
          if [ -n "$CENTRALD_URL" ]; then
            CORS_ORIGINS="$PORTAL_URL,$CENTRALD_URL"
          else
            CORS_ORIGINS="$PORTAL_URL"
          fi
          
          echo "Updating backend CORS with: $CORS_ORIGINS"
          gcloud run services update ${{ env.BACKEND_SERVICE }} \
            --region ${{ env.REGION }} \
            --update-env-vars "CORS_ORIGINS=$CORS_ORIGINS,FRONTEND_BASE_URL=$PORTAL_URL" \
            --quiet || echo "⚠️ Could not update backend CORS (backend may not exist yet)"
