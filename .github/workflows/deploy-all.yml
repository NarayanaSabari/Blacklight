# =============================================================================
# GitHub Actions - Deploy ALL Blacklight Services to Cloud Run
# =============================================================================
# Manual trigger only - deploys backend first, then both frontends
# Use this for initial deployment or full redeploy
# =============================================================================

name: Deploy All Services

on:
  workflow_dispatch:  # Manual trigger only

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.GCP_REGION || 'us-central1' }}

jobs:
  # ==========================================================================
  # Deploy Backend First
  # ==========================================================================
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    outputs:
      backend_url: ${{ steps.deploy.outputs.url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker --quiet

      - name: Build and Push Backend
        working-directory: ./server
        run: |
          docker build \
            -t gcr.io/${{ env.PROJECT_ID }}/blacklight-api:${{ github.sha }} \
            -t gcr.io/${{ env.PROJECT_ID }}/blacklight-api:latest \
            -f Dockerfile .
          docker push gcr.io/${{ env.PROJECT_ID }}/blacklight-api:${{ github.sha }}
          docker push gcr.io/${{ env.PROJECT_ID }}/blacklight-api:latest

      - name: Deploy Backend to Cloud Run
        id: deploy
        run: |
          gcloud run deploy blacklight-api \
            --image gcr.io/${{ env.PROJECT_ID }}/blacklight-api:${{ github.sha }} \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 2Gi \
            --cpu 2 \
            --min-instances 0 \
            --max-instances 100 \
            --timeout 300 \
            --concurrency 80 \
            --set-env-vars "\
              ENVIRONMENT=production,\
              FLASK_ENV=production,\
              FLASK_DEBUG=false,\
              LOG_LEVEL=INFO,\
              LOG_FORMAT=json,\
              STORAGE_BACKEND=gcs,\
              GCS_BUCKET_NAME=blacklight_freelance,\
              GCS_PROJECT_ID=${{ env.PROJECT_ID }},\
              AI_PARSING_PROVIDER=gemini,\
              GEMINI_MODEL=gemini-2.5-flash,\
              MAX_FILE_SIZE_MB=10,\
              SIGNED_URL_EXPIRY_SECONDS=3600,\
              SMTP_ENABLED=true,\
              SMTP_HOST=smtp.gmail.com,\
              SMTP_PORT=587,\
              SMTP_USE_TLS=true,\
              SMTP_FROM_EMAIL=sabariokg@gmail.com,\
              SMTP_FROM_NAME=BlackLight HR,\
              SMTP_USERNAME=sabariokg@gmail.com,\
              INNGEST_DEV=false" \
            --set-secrets "\
              SECRET_KEY=blacklight-secret-key:latest,\
              DATABASE_URL=blacklight-database-url:latest,\
              REDIS_URL=blacklight-redis-url:latest,\
              REDIS_CACHE_URL=blacklight-redis-url:latest,\
              GEMINI_API_KEY=blacklight-gemini-api-key:latest,\
              GOOGLE_API_KEY=blacklight-gemini-api-key:latest,\
              GCS_CREDENTIALS_JSON=blacklight-gcs-credentials:latest,\
              SMTP_PASSWORD=blacklight-smtp-password:latest"
          
          URL=$(gcloud run services describe blacklight-api \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "✅ Backend deployed to: $URL"

  # ==========================================================================
  # Deploy Both Frontends in Parallel
  # ==========================================================================
  deploy-portal:
    name: Deploy Portal
    runs-on: ubuntu-latest
    needs: deploy-backend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker --quiet

      - name: Build and Push Portal
        working-directory: ./ui/portal
        run: |
          docker build \
            -t gcr.io/${{ env.PROJECT_ID }}/blacklight-portal:${{ github.sha }} \
            -t gcr.io/${{ env.PROJECT_ID }}/blacklight-portal:latest \
            --build-arg VITE_API_URL=${{ needs.deploy-backend.outputs.backend_url }} \
            -f Dockerfile .
          docker push gcr.io/${{ env.PROJECT_ID }}/blacklight-portal:${{ github.sha }}
          docker push gcr.io/${{ env.PROJECT_ID }}/blacklight-portal:latest

      - name: Deploy Portal to Cloud Run
        run: |
          gcloud run deploy blacklight-portal \
            --image gcr.io/${{ env.PROJECT_ID }}/blacklight-portal:${{ github.sha }} \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 256Mi \
            --cpu 1 \
            --min-instances 0 \
            --max-instances 10 \
            --timeout 60 \
            --concurrency 200
          
          URL=$(gcloud run services describe blacklight-portal \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')
          echo "✅ Portal deployed to: $URL"

  deploy-centrald:
    name: Deploy CentralD
    runs-on: ubuntu-latest
    needs: deploy-backend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker --quiet

      - name: Build and Push CentralD
        working-directory: ./ui/centralD
        run: |
          docker build \
            -t gcr.io/${{ env.PROJECT_ID }}/blacklight-centrald:${{ github.sha }} \
            -t gcr.io/${{ env.PROJECT_ID }}/blacklight-centrald:latest \
            --build-arg VITE_API_URL=${{ needs.deploy-backend.outputs.backend_url }} \
            -f Dockerfile .
          docker push gcr.io/${{ env.PROJECT_ID }}/blacklight-centrald:${{ github.sha }}
          docker push gcr.io/${{ env.PROJECT_ID }}/blacklight-centrald:latest

      - name: Deploy CentralD to Cloud Run
        run: |
          gcloud run deploy blacklight-centrald \
            --image gcr.io/${{ env.PROJECT_ID }}/blacklight-centrald:${{ github.sha }} \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 256Mi \
            --cpu 1 \
            --min-instances 0 \
            --max-instances 5 \
            --timeout 60 \
            --concurrency 200
          
          URL=$(gcloud run services describe blacklight-centrald \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')
          echo "✅ CentralD deployed to: $URL"

  # ==========================================================================
  # Update Backend CORS with Frontend URLs
  # ==========================================================================
  update-cors:
    name: Update Backend CORS
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-portal, deploy-centrald]
    
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Update Backend CORS
        run: |
          PORTAL_URL=$(gcloud run services describe blacklight-portal \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')
          CENTRALD_URL=$(gcloud run services describe blacklight-centrald \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')
          
          echo "Portal URL: $PORTAL_URL"
          echo "CentralD URL: $CENTRALD_URL"
          
          gcloud run services update blacklight-api \
            --region ${{ env.REGION }} \
            --update-env-vars "CORS_ORIGINS=$PORTAL_URL,$CENTRALD_URL,FRONTEND_BASE_URL=$PORTAL_URL"
          
          echo ""
          echo "============================================"
          echo "✅ Deployment Complete!"
          echo "============================================"
          echo "Backend API: ${{ needs.deploy-backend.outputs.backend_url }}"
          echo "Portal: $PORTAL_URL"
          echo "CentralD: $CENTRALD_URL"
          echo "============================================"
