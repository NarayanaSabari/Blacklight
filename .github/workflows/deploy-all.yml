# ============================================================================
# Deploy All Services to Cloud Run
# ============================================================================
# Manual trigger only - deploys backend, portal, and central
# Use this for initial deployment or when you need to redeploy everything
#
# Required GitHub Secrets:
#   - GCP_PROJECT_ID: Your GCP project ID (blacklight-mvp-2)
#   - BACKEND_URL: Backend Cloud Run URL (set after first backend deploy)
#   - SECRET_KEY, DATABASE_URL, SMTP_PASSWORD, GOOGLE_API_KEY,
#     TOKEN_ENCRYPTION_KEY, GOOGLE_OAUTH_CLIENT_ID/SECRET,
#     MICROSOFT_OAUTH_CLIENT_ID/SECRET, INNGEST_EVENT_KEY,
#     INNGEST_SIGNING_KEY, INNGEST_BASE_URL, FRONTEND_BASE_URL
#
# Uses Workload Identity Federation for authentication (no JSON keys needed)
# ============================================================================

name: Deploy All

on:
  workflow_dispatch:  # Manual trigger only

env:
  REGION: asia-south1
  REPOSITORY: blacklight

# Required for Workload Identity Federation
permissions:
  contents: read
  id-token: write

jobs:
  # ==========================================================================
  # Deploy Backend First
  # ==========================================================================
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    outputs:
      backend_url: ${{ steps.get-url.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Google Auth (Workload Identity)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/52414647599/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'github-deployer@blacklight-mvp-2.iam.gserviceaccount.com'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Build and Push Backend
        run: |
          docker build \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/backend:${{ github.sha }} \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/backend:latest \
            -f server/Dockerfile.cloudrun \
            ./server
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/backend:${{ github.sha }}
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/backend:latest

      - name: Deploy Backend
        run: |
          # Get the backend URL (use existing if available)
          BACKEND_URL=$(gcloud run services describe blacklight-backend --region=${{ env.REGION }} --format='value(status.url)' 2>/dev/null || echo "https://blacklight-backend-pending.a.run.app")

          gcloud run deploy blacklight-backend \
            --image=${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/backend:${{ github.sha }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --memory=1Gi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=5 \
            --timeout=300 \
            --concurrency=80 \
            --service-account=blacklight-backend@blacklight-mvp-2.iam.gserviceaccount.com \
            --vpc-connector=projects/blacklight-mvp-2/locations/asia-south1/connectors/blacklight-connector \
            --vpc-egress=private-ranges-only \
            --set-env-vars="ENVIRONMENT=production" \
            --set-env-vars="SECRET_KEY=${{ secrets.SECRET_KEY }}" \
            --set-env-vars="DATABASE_URL=${{ secrets.DATABASE_URL }}" \
            --set-env-vars="FRONTEND_BASE_URL=${{ secrets.FRONTEND_BASE_URL }}" \
            --set-env-vars="STORAGE_BACKEND=gcs" \
            --set-env-vars="GCS_BUCKET_NAME=blacklight-mvp-2-files" \
            --set-env-vars="GCS_PROJECT_ID=blacklight-mvp-2" \
            --set-env-vars="SMTP_ENABLED=true" \
            --set-env-vars="SMTP_HOST=smtp.gmail.com" \
            --set-env-vars="SMTP_PORT=587" \
            --set-env-vars="SMTP_USERNAME=sabariokg@gmail.com" \
            --set-env-vars="SMTP_PASSWORD=${{ secrets.SMTP_PASSWORD }}" \
            --set-env-vars="SMTP_USE_TLS=true" \
            --set-env-vars="SMTP_FROM_EMAIL=sabariokg@gmail.com" \
            --set-env-vars="SMTP_FROM_NAME=BlackLight Company HR" \
            --set-env-vars="AI_PARSING_PROVIDER=gemini" \
            --set-env-vars="GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}" \
            --set-env-vars="GEMINI_MODEL=gemini-2.5-flash" \
            --set-env-vars="GEMINI_EMBEDDING_MODEL=gemini-embedding-001" \
            --set-env-vars="GEMINI_EMBEDDING_DIMENSION=768" \
            --set-env-vars="CORS_ORIGINS=*" \
            --set-env-vars="LOG_LEVEL=info" \
            --set-env-vars="REDIS_URL=redis://10.161.133.59:6379/0" \
            --set-env-vars="REDIS_CACHE_URL=redis://10.161.133.59:6379/1" \
            --set-env-vars="INNGEST_DEV=false" \
            --set-env-vars="INNGEST_BASE_URL=${{ secrets.INNGEST_BASE_URL }}" \
            --set-env-vars="INNGEST_EVENT_KEY=${{ secrets.INNGEST_EVENT_KEY }}" \
            --set-env-vars="INNGEST_SIGNING_KEY=${{ secrets.INNGEST_SIGNING_KEY }}" \
            --set-env-vars="INNGEST_SERVE_HOST=${BACKEND_URL}" \
            --set-env-vars="INNGEST_SERVE_PATH=/api/inngest" \
            --set-env-vars="TOKEN_ENCRYPTION_KEY=${{ secrets.TOKEN_ENCRYPTION_KEY }}" \
            --set-env-vars="GOOGLE_OAUTH_CLIENT_ID=${{ secrets.GOOGLE_OAUTH_CLIENT_ID }}" \
            --set-env-vars="GOOGLE_OAUTH_CLIENT_SECRET=${{ secrets.GOOGLE_OAUTH_CLIENT_SECRET }}" \
            --set-env-vars="GOOGLE_OAUTH_REDIRECT_URI=${BACKEND_URL}/api/integrations/email/callback/gmail" \
            --set-env-vars="EMAIL_SYNC_ENABLED=true" \
            --set-env-vars="EMAIL_SYNC_FREQUENCY_MINUTES=15" \
            --set-env-vars="EMAIL_SYNC_INITIAL_LOOKBACK_DAYS=10" \
            --set-env-vars="EMAIL_SYNC_MAX_EMAILS_PER_PAGE=100" \
            --set-env-vars="MICROSOFT_OAUTH_CLIENT_ID=${{ secrets.MICROSOFT_OAUTH_CLIENT_ID }}" \
            --set-env-vars="MICROSOFT_OAUTH_CLIENT_SECRET=${{ secrets.MICROSOFT_OAUTH_CLIENT_SECRET }}" \
            --set-env-vars="MICROSOFT_OAUTH_REDIRECT_URI=${BACKEND_URL}/api/integrations/email/callback/outlook" \
            --set-env-vars="MICROSOFT_OAUTH_TENANT=common" \
            --quiet

      - name: Get Backend URL
        id: get-url
        run: |
          URL=$(gcloud run services describe blacklight-backend --region=${{ env.REGION }} --format='value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "Backend deployed: $URL"

  # ==========================================================================
  # Deploy Frontends (after backend)
  # ==========================================================================
  deploy-portal:
    name: Deploy Portal
    runs-on: ubuntu-latest
    needs: deploy-backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Google Auth (Workload Identity)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/52414647599/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'github-deployer@blacklight-mvp-2.iam.gserviceaccount.com'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Build and Push Portal
        run: |
          docker build \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/portal:${{ github.sha }} \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/portal:latest \
            --build-arg VITE_API_BASE_URL=${{ needs.deploy-backend.outputs.backend_url }} \
            --build-arg VITE_ENVIRONMENT=production \
            --build-arg VITE_BASE_PATH=/ \
            ./ui/portal
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/portal:${{ github.sha }}
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/portal:latest

      - name: Deploy Portal
        run: |
          gcloud run deploy blacklight-portal \
            --image=${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/portal:${{ github.sha }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --memory=512Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=5 \
            --timeout=60 \
            --concurrency=100 \
            --quiet

      - name: Show Portal URL
        run: |
          echo "Portal deployed: $(gcloud run services describe blacklight-portal --region=${{ env.REGION }} --format='value(status.url)')"

  deploy-central:
    name: Deploy Central
    runs-on: ubuntu-latest
    needs: deploy-backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Google Auth (Workload Identity)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/52414647599/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'github-deployer@blacklight-mvp-2.iam.gserviceaccount.com'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Build and Push Central
        run: |
          docker build \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/central:${{ github.sha }} \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/central:latest \
            --build-arg VITE_API_BASE_URL=${{ needs.deploy-backend.outputs.backend_url }} \
            --build-arg VITE_ENVIRONMENT=production \
            --build-arg VITE_BASE_PATH=/ \
            ./ui/centralD
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/central:${{ github.sha }}
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/central:latest

      - name: Deploy Central
        run: |
          gcloud run deploy blacklight-central \
            --image=${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/central:${{ github.sha }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --memory=512Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=3 \
            --timeout=60 \
            --concurrency=100 \
            --quiet

      - name: Show Central URL
        run: |
          echo "Central deployed: $(gcloud run services describe blacklight-central --region=${{ env.REGION }} --format='value(status.url)')"

  # ==========================================================================
  # Update Backend CORS (after frontends are deployed)
  # ==========================================================================
  update-cors:
    name: Update Backend CORS
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-portal, deploy-central]

    steps:
      - name: Google Auth (Workload Identity)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/52414647599/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'github-deployer@blacklight-mvp-2.iam.gserviceaccount.com'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Update CORS Settings
        run: |
          PORTAL_URL=$(gcloud run services describe blacklight-portal --region=${{ env.REGION }} --format='value(status.url)')
          CENTRAL_URL=$(gcloud run services describe blacklight-central --region=${{ env.REGION }} --format='value(status.url)')
          
          gcloud run services update blacklight-backend \
            --region=${{ env.REGION }} \
            --update-env-vars="CORS_ORIGINS=${PORTAL_URL},${CENTRAL_URL}" \
            --update-env-vars="FRONTEND_BASE_URL=${PORTAL_URL}" \
            --quiet
          
          echo ""
          echo "=========================================="
          echo "All Services Deployed Successfully!"
          echo "=========================================="
          echo ""
          echo "Backend:  ${{ needs.deploy-backend.outputs.backend_url }}"
          echo "Portal:   ${PORTAL_URL}"
          echo "Central:  ${CENTRAL_URL}"
          echo ""
          echo "CORS has been configured automatically."
          echo "=========================================="
