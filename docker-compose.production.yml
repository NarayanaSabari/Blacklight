version: "3.9"

services:
  # =============================================================================
  # Nginx Reverse Proxy - Routes traffic to frontends and backend
  # =============================================================================
  nginx:
    image: nginx:alpine
    container_name: blacklight-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - nginx_cache:/var/cache/nginx
      - nginx_logs:/var/log/nginx
    depends_on:
      - backend
      - portal
      - centrald
    networks:
      - blacklight-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # =============================================================================
  # Flask Backend - API Server
  # =============================================================================
  backend:
    build:
      context: ./server
      dockerfile: Dockerfile
      target: production
    container_name: blacklight-backend
    environment:
      # Flask Configuration
      ENVIRONMENT: production
      PORT: 5000
      FLASK_APP: wsgi.py
      FLASK_ENV: production
      FLASK_DEBUG: "False"

      # Database
      DATABASE_URL: postgresql+psycopg2://postgres:${POSTGRES_PASSWORD:-postgres}@postgres:5432/blacklight
      SQLALCHEMY_ECHO: "False"
      SQLALCHEMY_TRACK_MODIFICATIONS: "False"
      SQLALCHEMY_ENGINE_OPTIONS_POOL_SIZE: 10
      SQLALCHEMY_ENGINE_OPTIONS_POOL_RECYCLE: 3600
      SQLALCHEMY_ENGINE_OPTIONS_POOL_PRE_PING: "True"

      # Redis
      REDIS_URL: redis://redis:6379/0
      REDIS_CACHE_URL: redis://redis:6379/1

      # Security
      SECRET_KEY: ${SECRET_KEY}
      ALLOWED_HOSTS: ${ALLOWED_HOSTS:-localhost,127.0.0.1}

      # CORS
      CORS_ORIGINS: ${CORS_ORIGINS:-*}
      CORS_ALLOW_HEADERS: "*"
      CORS_EXPOSE_HEADERS: "*"
      CORS_SUPPORTS_CREDENTIALS: "True"

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FORMAT: json

      # AI Parsing
      AI_PARSING_PROVIDER: gemini
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}
      GEMINI_MODEL: ${GEMINI_MODEL:-gemini-2.5-flash}
      GEMINI_EMBEDDING_MODEL: ${GEMINI_EMBEDDING_MODEL:-gemini-embedding-001}
      GEMINI_EMBEDDING_DIMENSION: ${GEMINI_EMBEDDING_DIMENSION:-768}

      # Google Cloud Storage
      STORAGE_BACKEND: ${STORAGE_BACKEND:-gcs}
      GCS_BUCKET_NAME: ${GCS_BUCKET_NAME}
      GCS_PROJECT_ID: ${GCS_PROJECT_ID}
      GCS_CREDENTIALS_PATH: /app/gcs-credentials.json
      SIGNED_URL_EXPIRY_SECONDS: 3600

      # File Uploads
      MAX_FILE_SIZE_MB: 10
      ALLOWED_DOCUMENT_TYPES: pdf,doc,docx,jpg,jpeg,png
      RESUME_UPLOAD_MAX_SIZE_MB: 10
      RESUME_ALLOWED_EXTENSIONS: pdf,docx
      RESUME_STORAGE_PATH: uploads/resumes

      # SMTP Configuration
      SMTP_ENABLED: ${SMTP_ENABLED:-true}
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USERNAME: ${SMTP_USERNAME}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      SMTP_USE_TLS: ${SMTP_USE_TLS:-true}
      SMTP_FROM_EMAIL: ${SMTP_FROM_EMAIL}
      SMTP_FROM_NAME: ${SMTP_FROM_NAME:-BlackLight Company HR}

      # Frontend URLs
      FRONTEND_BASE_URL: ${FRONTEND_BASE_URL:-http://localhost}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost}
      CENTRALD_URL: ${CENTRALD_URL:-http://localhost}

      # Inngest
      INNGEST_EVENT_KEY: ${INNGEST_EVENT_KEY}
      INNGEST_SIGNING_KEY: ${INNGEST_SIGNING_KEY}

      # Server Config
      HOST: 0.0.0.0
      WORKERS: 4
      WORKER_CLASS: gthread
      WORKER_CONNECTIONS: 1000

    volumes:
      - ./server/gcs-credentials.json:/app/gcs-credentials.json:ro
      - backend_uploads:/app/uploads
      - backend_storage:/app/storage
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - blacklight-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:5000/api/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # =============================================================================
  # Portal Frontend - React App
  # =============================================================================
  portal:
    build:
      context: ./ui/portal
      dockerfile: Dockerfile
      target: production
      args:
        VITE_API_URL: ${VITE_PORTAL_API_URL:-/api}
        VITE_APP_NAME: ${VITE_PORTAL_APP_NAME:-Blacklight Portal}
    container_name: blacklight-portal
    networks:
      - blacklight-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M

  # =============================================================================
  # CentralD Frontend - React App
  # =============================================================================
  centrald:
    build:
      context: ./ui/centralD
      dockerfile: Dockerfile
      target: production
      args:
        VITE_API_URL: ${VITE_CENTRALD_API_URL:-/api}
        VITE_APP_NAME: ${VITE_CENTRALD_APP_NAME:-Blacklight CentralD}
    container_name: blacklight-centrald
    networks:
      - blacklight-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M

  # =============================================================================
  # PostgreSQL Database with pgvector Extension
  # =============================================================================
  postgres:
    image: pgvector/pgvector:pg15
    container_name: blacklight-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: blacklight
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backups:/backups
    networks:
      - blacklight-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres -d blacklight" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    command:
      - "postgres"
      - "-c"
      - "max_connections=200"
      - "-c"
      - "shared_buffers=256MB"
      - "-c"
      - "effective_cache_size=1GB"
      - "-c"
      - "maintenance_work_mem=64MB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "wal_buffers=16MB"
      - "-c"
      - "default_statistics_target=100"
      - "-c"
      - "random_page_cost=1.1"
      - "-c"
      - "effective_io_concurrency=200"
      - "-c"
      - "work_mem=1MB"
      - "-c"
      - "min_wal_size=1GB"
      - "-c"
      - "max_wal_size=4GB"

  # =============================================================================
  # Redis Cache
  # =============================================================================
  redis:
    image: redis:7-alpine
    container_name: blacklight-redis
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - blacklight-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M

  # =============================================================================
  # pgAdmin (Optional - Database Management UI)
  # =============================================================================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: blacklight-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@blacklight.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
      PGADMIN_CONFIG_SERVER_MODE: "False"
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: "False"
    ports:
      - "5050:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      - postgres
    networks:
      - blacklight-network
    restart: unless-stopped
    profiles:
      - tools
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

  # =============================================================================
  # Redis Commander (Optional - Redis Management UI)
  # =============================================================================
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: blacklight-redis-commander
    environment:
      REDIS_HOSTS: "local:redis:6379"
    ports:
      - "8081:8081"
    depends_on:
      - redis
    networks:
      - blacklight-network
    restart: unless-stopped
    profiles:
      - tools
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M

# =============================================================================
# Persistent Volumes
# =============================================================================
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  backend_uploads:
    driver: local
  backend_storage:
    driver: local
  nginx_cache:
    driver: local
  nginx_logs:
    driver: local
  pgadmin_data:
    driver: local

# =============================================================================
# Network Configuration
# =============================================================================
networks:
  blacklight-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
